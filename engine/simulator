#!/usr/bin/octave -qf
% Include to path the control toolbox:

warning("off");
addpath('/usr/share/octave/packages/3.2/control-1.0.11/');
%
%JSONLAB Library for Octave/Matlab
%Reference: http://iso2mesh.sourceforge.net/cgi-bin/index.cgi?jsonlab/savejson.m
addpath('/var/www/vlab/engine/jsonlab/');

arg_list=argv();
for index=1:nargin
    temp = arg_list{index};
    if strcmp(temp,"-P");
        P=str2num(arg_list{++index});
    elseif strcmp(temp,"-Q")
        Q=str2num(arg_list{++index});
    elseif strcmp(temp,"-Pm")
        Pm=str2num(arg_list{++index});
    elseif strcmp(temp,"-Qm")
        Qm=str2num(arg_list{++index});
    elseif strcmp(temp,"-Pc")
        Pc=str2num(arg_list{++index});
    elseif strcmp(temp,"-Qc")
        Qc=str2num(arg_list{++index});
    elseif strcmp(temp,"-Pf")
        Pf=str2num(arg_list{++index});
    elseif strcmp(temp,"-Qf")
        Qf=str2num(arg_list{++index});
    elseif strcmp(temp,"-setpoint")
        setpoint=str2num(arg_list{++index});
    elseif strcmp(temp,"-id")
        id=arg_list{++index};
    elseif strcmp(temp,"-closed_loop")
        closed_loop=str2num(arg_list{++index});
    end
end

if (!exist("Pc","var")) || isempty(Pc)
 Pc=1;
end

if (!exist("Pf","var")) || isempty(Pf)
 Pf=1;
end
if (!exist("Qf","var")) || isempty(Qf)
 Qf=1;
end


if (!exist("Pm","var")) || isempty(Pm)
 Pm=1;
end
if (!exist("Qm","var")) || isempty(Qm)
 Qm=1;
end

if (!exist("closed_loop","var")) || isempty(closed_loop)
 closed_loop=0;
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%% Computational Part %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% TODO: Take care of the delay!

if (closed_loop==1)
    firstProduct=conv(conv(P,Pc),Pf);
    denomProduct=conv(conv(conv(Q,Qf),Qc),Qm);
    P_=conv(firstProduct,Qm);
    Qcl_2=conv(firstProduct,Pm);
    Q_=polyadd(Qcl_2, denomProduct);
else
    P_ = conv(conv(conv(P,Pc),Pm),Pf);
    Q_ = conv(conv(conv(Q,Qc),Qm),Qf);
end
sys=tf(P_,Q_);

[y,t] = step(sys,1,10,500);
response = struct('y',y, 't',t, 'P',P, 'Q',Q, 'Pc',Pc, 'Qc',Qc, 'Pf',Pf,...
    'Qf',Qf, 'Pm',Pm, 'Qm',Qm, 'P_',P_, 'Q_',Q_, 'id',id, ...
    'closed_loop',closed_loop,'timestamp',time);
json = savejson('response',response);
disp(json);

fid = fopen([id '.json'], 'w');
fdisp(fid, json);
fclose(fid);